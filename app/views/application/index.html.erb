<% content_for titulo "" %>
<h1><%= Rails.application.class.module_parent_name %></h1>


<!-- atendimentos de hoje -->
<% if !@atendimentos_hoje.empty? %>
  <table class="table-atendimento">
    <caption>Atendimentos de hoje</caption>
    <thead>
      <tr>
        <th>Profissional</th>
        <th>Paciente</th>
        <th>Tipo</th>
        <th>Horário</th>
        <th>Presença</th>
      </tr>
    </thead>

    <tbody>
      <% @atendimentos_hoje.each do |ah| %>
        <% presenca_class = ah.horario_passado ? ah.presenca ? "td-atendimento-presente" : "td-atendimento-ausente" : "td-atendimento-futuro" %>
        <% presenca_class = ah.presenca ? "td-atendimento-presente" : ah.horario_passado ? "td-atendimento-ausente" : "td-atendimento-futuro" %>
        <tr>
          <td class="<%= presenca_class %> td-atendimento">
            <%= link_to ah.profissional do %><%= ah.profissional.nome_completo %>
              <span style="font-size:.7em;"><%= ah.profissional.documento %></span>
          <% end %>
          </td>
          <td class="<%= presenca_class %> td-atendimento">
            <%= link_to ah.pessoa.nome_completo, ah.pessoa %>
          </td>
          <td class="<%= presenca_class %> td-atendimento">
            <%= ah.tipo %>
          </td>
          <td class="<%= presenca_class %> td-atendimento">
            <%= link_to (render_hora_brasil ah.horario), ah %>
          </td>
          <td class="<%= presenca_class %> td-atendimento">
            <%= ah.horario_passado ? ah.pessoa_presente_desc : ah.presenca ? "Em andamento" : "A ocorrer" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>

<!-- calendário mensal -->
<%
=begin
%>
  <h2>
    Atendimentos do mês
    <span style="font-size:.7em;">
      (<%= @atendimentos.count %>)
    </span>
  </h2>
  <%= month_calendar(events: @atendimentos, attribute: :data) do |date, atendimentos| %>
    <div>
      <div class="calendario-dia"><%= date.strftime("%d") %></div>

      <% atendimentos.each do |atendimento| %>
        <%= render "atendimentos/atendimento-card", atendimento: atendimento %>
      <% end %>
    </div>
  <% end %>
<%
=end
%>

<%= form_with url: "/", method: :get do |form| %>
  <%= form.label :semana_select, "Semana do dia" %>
  <%= form.week_field [start_date: @start_date], onchange: "window.location.search = '?start_date=' + this.value", value: @start_date %>
<% end %>

<!-- calendário semanal? -->
<h3><%= @atendimentos.count %> atendimentos nesta semana</h3>
<p>
  <% atendidos = @atendimentos.where(presenca: true).count %>
  <% nao_atendidos = @atendimentos.where("data < CURRENT_DATE || (data = CURRENT_DATE AND HOUR(horario) < HOUR(CURRENT_TIME)) AND presenca = FALSE").count %>
  <% futuros = @atendimentos.where("data >= CURRENT_DATE && HOUR(horario) > HOUR(CURRENT_TIME)").count %>
  <%= atendidos %> <%= 'realizados'.pluralize(atendidos) %>,
  <%= nao_atendidos %> <%= 'não realizado'.pluralize(nao_atendidos) %>,
  <%= futuros %> <%= 'futuro'.pluralize(futuros) %>.
</p>
<%= week_calendar(events: @atendimentos, attribute: :data) do |date, atendimentos|%>
  <div class="day">
    <%= date.day %>
  </div>
  <% atendimentos.each do |atendimento| %>
    <%= render "atendimentos/atendimento-card", atendimento: atendimento %>
  <% end %>
<% end %>
